const puppeteer = require('puppeteer');
const pool = require('../config/database');
const fs = require('fs');
const path = require('path');

// Generar PDF usando HTML + Puppeteer
const generarPDF = async(req, res) =& gt; {
  try {
    const { id } = req.params;
    console.log(`üîç Generando PDF (HTML) para muestra ID: ${id}`);

    // 1. Obtener datos de la muestra principal y el paciente
    const muestraResult = await pool.query(
      `SELECT m.*, p.nombre as paciente_nombre, p.cedula, p.telefono, 
              p.fecha_nacimiento, p.genero, p.id as paciente_id
       FROM muestras m 
       JOIN pacientes p ON m.paciente_id = p.id 
       WHERE m.id = $1`,
      [id]
    );

    if (muestraResult.rows.length === 0) {
      return res.status(404).json({ error: 'Muestra no encontrada' });
    }

    const muestra = muestraResult.rows[0];
    const pacienteId = muestra.paciente_id;

    // 2. Obtener TODAS las muestras del mismo paciente (del mismo pedido)
    const todasMuestrasResult = await pool.query(
      `SELECT m.id as muestra_id, m.fecha_toma, m.observaciones
       FROM muestras m
       WHERE m.paciente_id = $1
       ORDER BY m.fecha_toma DESC`,
      [pacienteId]
    );

    const muestrasDelPaciente = todasMuestrasResult.rows;

    // 3. Obtener TODOS los detalles de TODAS las muestras del paciente
    const todosDetallesResult = await pool.query(
      `SELECT dm.*, m.id as muestra_id, m.fecha_toma
       FROM detalle_muestras dm
       JOIN muestras m ON dm.muestra_id = m.id
       WHERE m.paciente_id = $1
       ORDER BY m.fecha_toma DESC, dm.tipo_muestra`,
      [pacienteId]
    );

    const detalles = todosDetallesResult.rows;

    if (detalles.length === 0) {
      return res.status(400).json({ error: 'No hay datos de muestras para generar el PDF' });
    }

    // 4. Preparar Template
    const templatePath = path.join(__dirname, '..', 'templates', 'reporte.html');
    let html = fs.readFileSync(templatePath, 'utf8');

    // 5. Cargar Logo en Base64
    const logoPath = path.join(__dirname, '..', 'logo-laboratorio.png');
    let logoBase64 = '';
    if (fs.existsSync(logoPath)) {
      const logoData = fs.readFileSync(logoPath);
      logoBase64 = `data:image/png;base64,${logoData.toString('base64')}`;
    }

    // 6. Reemplazar Datos Generales
    html = html.replace('{{LOGO_BASE64}}', logoBase64)
      .replace('{{PACIENTE_NOMBRE}}', muestra.paciente_nombre)
      .replace('{{CEDULA}}', muestra.cedula)
      .replace('{{ORDEN_ID}}', `Pedido del paciente ${muestra.paciente_nombre}`)
      .replace('{{FECHA}}', new Date(muestra.fecha_toma).toLocaleDateString('es-ES'))
      .replace('{{FECHA_GENERACION}}', new Date().toLocaleString('es-ES'));

    // 7. Generar Contenido de Tablas para TODAS las muestras
    let contenidoHtml = '';

    // Agrupar detalles por muestra
    const detallesPorMuestra = {};
    detalles.forEach(detalle =& gt; {
      if (!detallesPorMuestra[detalle.muestra_id]) {
        detallesPorMuestra[detalle.muestra_id] = [];
      }
      detallesPorMuestra[detalle.muestra_id].push(detalle);
    });

    // Generar HTML para cada muestra
    Object.keys(detallesPorMuestra).forEach((muestraId, index) =& gt; {
      if (index & gt; 0) {
        contenidoHtml += `&lt;div class="page-break"&gt;&lt;/div&gt;`;
      }

      const muestraInfo = muestrasDelPaciente.find(m =& gt; m.muestra_id === parseInt(muestraId));
      contenidoHtml += `&lt;h3 style="margin-top: 20px; color: #2563eb;"&gt;Muestra #${muestraId} - ${new Date(muestraInfo.fecha_toma).toLocaleDateString('es-ES')}&lt;/h3&gt;`;

      if (muestraInfo.observaciones) {
        contenidoHtml += `&lt;p style="font-size: 11px; color: #6b7280; font-style: italic;"&gt;${muestraInfo.observaciones}&lt;/p&gt;`;
      }

      detallesPorMuestra[muestraId].forEach(detalle =& gt; {
        contenidoHtml += generarSeccionHTML(detalle);
      });
    });

    html = html.replace('{{CONTENT}}', contenidoHtml);

    // 8. Generar PDF con Puppeteer
    const browser = await puppeteer.launch({
      headless: 'new',
      args: ['--no-sandbox', '--disable-setuid-sandbox'] // Necesario en algunos entornos servidor
    });
    const page = await browser.newPage();

    // Cargar contenido HTML
    await page.setContent(html, { waitUntil: 'networkidle0' });

    // Generar PDF
    const pdfBuffer = await page.pdf({
      format: 'Letter',
      landscape: true,
      printBackground: true,
      margin: {
        top: '1cm',
        right: '1cm',
        bottom: '1cm',
        left: '1cm'
      },
      displayHeaderFooter: false // Usamos nuestro propio header/footer en HTML si es necesario, o CSS print
    });

    await browser.close();

    // 9. Enviar Respuesta
    res.setHeader('Content-Type', 'application/pdf');
    res.setHeader('Content-Disposition', `attachment; filename=Reporte_${muestra.paciente_nombre.replace(/\s+/g, '_')}.pdf`);
    res.send(pdfBuffer);

    console.log('‚úÖ PDF generado correctamente con Puppeteer (todas las muestras del paciente)');

  } catch (error) {
    console.error('‚ùå Error al generar PDF:', error);
    res.status(500).json({ error: 'Error al generar PDF: ' + error.message });
  }
};

// Helper para generar HTML de cada secci√≥n
function generarSeccionHTML(detalle) {
  let html = `&lt;div class="section"&gt;`;

  // T√≠tulo
  let titulo = '';
  switch (detalle.tipo_muestra) {
    case 'sangre': titulo = 'HEMATOLOG√çA COMPLETA'; break;
    case 'orina': titulo = 'UROAN√ÅLISIS'; break;
    case 'heces': titulo = 'COPROL√ìGICO'; break;
    default: titulo = detalle.tipo_muestra.toUpperCase();
  }
  html += `&lt;div class="section-title"&gt;${titulo}&lt;/div&gt;`;

  // Tabla
  html += `&lt;table&gt;
    &lt;thead&gt;
      &lt;tr&gt;
        &lt;th style="width: 35%"&gt;Par√°metro&lt;/th&gt;
        &lt;th style="width: 20%"&gt;Resultado&lt;/th&gt;
        &lt;th style="width: 15%"&gt;Unidad&lt;/th&gt;
        &lt;th style="width: 30%"&gt;Valores de Referencia&lt;/th&gt;
      &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;`;

  const resultados = detalle.resultados || {};
  const filas = obtenerFilasPorTipo(detalle.tipo_muestra, resultados);

  filas.forEach(fila =& gt; {
    html += `&lt;tr&gt;
      &lt;td&gt;${fila.param}&lt;/td&gt;
      &lt;td&gt;${fila.valor !== undefined & amp;& amp; fila.valor !== null & amp;& amp; fila.valor !== '' ? fila.valor : '-'
  }& lt;/td&gt;
      & lt; td & gt;${ fila.unidad || '-' }& lt;/td&gt;
      & lt; td & gt;${ fila.referencia || '-' }& lt;/td&gt;
    & lt;/tr&gt;`;
});

html += `&lt;/tbody&gt;&lt;/table&gt;`;

// Observaciones
if (detalle.observaciones) {
  html += `&lt;div class="observations"&gt;
      &lt;h4&gt;Observaciones:&lt;/h4&gt;
      &lt;p&gt;${detalle.observaciones}&lt;/p&gt;
    &lt;/div&gt;`;
}

html += `&lt;/div&gt;`;
return html;
}

// Helper para definir las filas seg√∫n el tipo de muestra
function obtenerFilasPorTipo(tipo, resultados) {
  switch (tipo) {
    case 'sangre':
      return [
        { param: 'Hemoglobina', valor: resultados.hemoglobina, unidad: 'g/dL', referencia: '12.0 - 18.0' },
        { param: 'Hematocrito', valor: resultados.hematocrito, unidad: '%', referencia: '36.0 - 52.0' },
        { param: 'Leucocitos', valor: resultados.leucocitos, unidad: '/mm¬≥', referencia: '4,000 - 11,000' },
        { param: 'Plaquetas', valor: resultados.plaquetas, unidad: '/mm¬≥', referencia: '150,000 - 400,000' },
        { param: 'Glucosa', valor: resultados.glucosa, unidad: 'mg/dL', referencia: '70 - 100' },
        { param: 'VCM', valor: resultados.vcm, unidad: 'fL', referencia: '80 - 100' },
        { param: 'HCM', valor: resultados.hcm, unidad: 'pg', referencia: '27 - 31' },
        { param: 'CHCM', valor: resultados.chcm, unidad: 'g/dL', referencia: '32 - 36' },
      ];
    case 'orina':
      return [
        { param: 'Color', valor: resultados.color, unidad: '-', referencia: 'Amarillo claro' },
        { param: 'Aspecto', valor: resultados.aspecto, unidad: '-', referencia: 'Transparente' },
        { param: 'pH', valor: resultados.ph, unidad: '-', referencia: '4.5 - 8.0' },
        { param: 'Densidad', valor: resultados.densidad, unidad: '-', referencia: '1.003 - 1.030' },
        { param: 'Glucosa', valor: resultados.glucosa, unidad: '-', referencia: 'Negativo' },
        { param: 'Prote√≠nas', valor: resultados.proteinas, unidad: '-', referencia: 'Negativo' },
        { param: 'Sangre', valor: resultados.sangre, unidad: '-', referencia: 'Negativo' },
        { param: 'Leucocitos', valor: resultados.leucocitos, unidad: '/campo', referencia: '0 - 5' },
        { param: 'Bacterias', valor: resultados.bacterias, unidad: '-', referencia: 'Negativo' },
        { param: 'Cristales', valor: resultados.cristales, unidad: '-', referencia: 'Negativo' },
      ];
    case 'heces':
      return [
        { param: 'Consistencia', valor: resultados.consistencia, unidad: '-', referencia: 'S√≥lida/Blanda' },
        { param: 'Color', valor: resultados.color, unidad: '-', referencia: 'Marr√≥n' },
        { param: 'pH', valor: resultados.ph, unidad: '-', referencia: '6.0 - 7.5' },
        { param: 'Sangre oculta', valor: resultados.sangre_oculta, unidad: '-', referencia: 'Negativo' },
        { param: 'Par√°sitos', valor: resultados.parasitos, unidad: '-', referencia: 'Negativo' },
        { param: 'Leucocitos', valor: resultados.leucocitos, unidad: '/campo', referencia: '0 - 3' },
        { param: 'Moco', valor: resultados.moco, unidad: '-', referencia: 'Negativo' },
        { param: 'Restos alimenticios', valor: resultados.restos_alimenticios, unidad: '-', referencia: 'Normal' },
      ];
    default:
      return [];
  }
}

module.exports = {
  generarPDF
};
