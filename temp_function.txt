// Obtener muestras del paciente autenticado (para clientes)
exports.obtenerMisMuestras = async (req, res) =u003e {
  try {
    const pacienteId = req.usuario.paciente_id; // ID del paciente desde el token
    
    if (!pacienteId) {
      return res.status(400).json({ error: 'Usuario no asociado a un paciente' });
    }

    const result = await pool.query(`
      SELECT m.*, p.nombre as paciente_nombre, p.cedula,
             COALESCE(
               JSON_AGG(
                 JSON_BUILD_OBJECT(
                   'id', dm.id,
                   'tipo_muestra', dm.tipo_muestra,
                   'tiene_resultados', CASE WHEN dm.resultados::text != '{}'::text THEN true ELSE false END
                 ) ORDER BY dm.tipo_muestra
               ) FILTER (WHERE dm.id IS NOT NULL),
               '[]'::json
             ) as tipos_muestras
      FROM muestras m
      JOIN pacientes p ON m.paciente_id = p.id
      LEFT JOIN detalle_muestras dm ON m.id = dm.muestra_id
      WHERE m.paciente_id = $1
      GROUP BY m.id, p.nombre, p.cedula
      ORDER BY m.fecha_toma DESC
    `, [pacienteId]);

    res.json(result.rows);
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Error al obtener muestras' });
  }
};
